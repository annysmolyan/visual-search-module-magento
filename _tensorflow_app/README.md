# Python Tensorflow Api Application for getting image vectors

This application contains a Docker setup for running TensorFlow, Jupyter Notebook, 
and a Flask application within a single container. 

It is primarily intended for development and testing purposes. 

This application is used for Magento Ecommerce stores.

## Installation
Copy this module to a separate directory from Magento.

The application can be installed by Makefile. Before installation,
you have to set correct mounting for your magento "pub/media" directory and "var/visual_search" directory.

It can be done in docker-compose.xml file:


```
    volumes:
      - ./source:/source
      - MAGENTO_PUB_MEDIA_PATH:/magento_media #set mounting to magento pub/media folder
      - MAGENTO_VAR_VISUAL_SEARCH_PATH:/magento_csv #set mounting to magento var/visual_search folder (for csv files)
```

<b>WARNING! Don't change paths inside container!!!</b>

<b>MIND! If your Magento store is under Docker too, make sure that Magento and this app are under the same
network.</b>

* Init application - build and run container. During init command you can
adjust memory usage here: 	<b>sudo sysctl -w vm.max_map_count=262144</b>


```
    make init
```

* Start application - just run container

```
    make start
```

* Stop application - stop container

```
    make stop
```

The application uses Flask + Gunicorn as server.

The application uses 5000 port by default.



## Image Feature API Overview


### Extract Images Features From Csv File:

Use this method when need to process multiple images.

The logic is as follows: Magento generates a CSV file and places it in the 'var/visual_search' directory. This folder must be mounted in the 'docker-compose.yml' file.

The CSV file must contain two columns: 'image_pub_media_path' and 'vector.'

Magento populates the first column with image paths in pub/media dir, and the application generates vectors and stores them in the file. 
In case of an error, the error details will also be recorded in the CSV file.

* TYPE: POST
* ENDPOINT: http://localhost:5000/feature-extract/csv-source
* PARAMETERS: 
  

   -- "modelName" - string. Model to process vector generation. 
   Currently, can be only "InceptionV3"

   -- "csvFileName" - string. Name of csv file, generated by Magento. Images paths must be without slash at the beginning. 
e.g. 'catalog/product/m/b/mb01-blue-0.jpg'. 
   
WARNING! csv file must have 2 columns: "image_pub_media_path" and "vector". Delimiter is ','


* REQUEST EXAMPLE:

```
POST http://localhost:5000/feature-extract/csv-source


{
    "modelName": "InceptionV3",
    "csvFileName": "image.csv"
}

```

RESPONSE SUCCESS EXAMPLE:

```
Status 200 will be returned without body
```


RESPONSE ERROR EXAMPLE:

```
{
    "error": "Undefined CNN model name",
}

```


### Extract Images Features From Pub Media Path:

Get image vector for a single image by giving path in "pub/media".

WARNING! If you need process multiple images, use the endpoint above instead!

* TYPE: POST
* ENDPOINT: http://localhost:5000/feature-extract/path-source
* PARAMETERS: 

-- "modelName" - string. Model to process vector generation. Currently, can be only "InceptionV3"

-- "path" - string. Image path in Magento "pub/media" directory, without slash at the beginning.
e.g. 'catalog/product/m/b/mb01-blue-0.jpg'


* REQUEST EXAMPLE:

```
POST http://localhost:5000/feature-extract/path-source


{
    "modelName": "InceptionV3",
    "path": "catalog/product/m/b/mb01-blue-0.jpg"
}

```

RESPONSE SUCCESS EXAMPLE:

```
{
    "vector": [array]
}
```


RESPONSE ERROR EXAMPLE:

```
{
    "error": "Undefined CNN model name",
}

```






## CNN Models Overview:

| Model             | Overview                                                                                                                                                                                                                                                                                                          |
|-------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| InceptionV3       | https://www.tensorflow.org/api_docs/python/tf/keras/applications/inception_v3/InceptionV3 <br/> WARNING! Don't change classes value here ```InceptionV3(weights='imagenet', classes=1000).``` It must be 1000<br/> If you change it, it must be also changed in magento (dimension param for elasticsearch, see BelSmol\VisualSearch\Model\Manager\TensorflowManager::getCnnModelVectorDimension method) |
|               |                                                                                                                                                                                                                                                                                                                   |
